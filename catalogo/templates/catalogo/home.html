{% extends "catalogo/base.html" %}
{% load custom_filters %}
{% load static %}
{% block title %}Inicio ‚Äî Tienda MVC{% endblock %}

{% block content %}
<section class="space-y-10">

  <!-- Productos M√°s Vendidos -->
  <div>
    <h2 class="text-2xl font-bold text-indigo-700 mb-4">üõí Productos m√°s vendidos</h2>
    <div class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-lg p-6">

      <!-- Tabla -->
      <table class="w-full text-sm">
        <thead class="text-left text-gray-600 border-b">
          <tr>
            <th class="py-2">Producto</th>
            <th class="py-2">Cantidad vendida</th>
          </tr>
        </thead>
        <tbody>
          {% for p in productos_vendidos %}
          <tr class="border-b hover:bg-indigo-50/40 transition">
            <td class="py-2 font-medium">{{ p.producto__nombre }}</td>
            <td class="py-2">{{ p.total_vendido }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="2" class="text-gray-500 py-2">Sin datos a√∫n.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Gr√°fico -->
      <div class="mt-6 flex justify-center">
        <div class="w-[900px] h-[400px] p-4 rounded-xl bg-gray-50 shadow-inner">

          <!-- üî• Ajuste correcto del canvas -->
          <canvas id="chartProductos" width="900" height="400" class="!w-full !h-full"></canvas>

        </div>
      </div>
    </div>
  </div>

  <!-- Clientes con m√°s Ventas -->
  <div>
    <h2 class="text-2xl font-bold text-indigo-700 mb-4">üë• Clientes con m√°s ventas</h2>
    <div class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-lg p-6">

      <!-- Tabla -->
      <table class="w-full text-sm">
        <thead class="text-left text-gray-600 border-b">
          <tr>
            <th class="py-2">Cliente</th>
            <th class="py-2">Ventas realizadas</th>
          </tr>
        </thead>
        <tbody>
          {% for c in clientes_top %}
          <tr class="border-b hover:bg-indigo-50/40 transition">
            <td class="py-2 font-medium">{{ c.cliente__nombre }}</td>
            <td class="py-2">{{ c.total_compras }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="2" class="text-gray-500 py-2">Sin datos a√∫n.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Gr√°fico -->
      <div class="mt-6 flex justify-center">
        <div class="w-[700px] h-[400px] p-4 rounded-xl bg-gray-50 shadow-inner">

          <!-- üî• Ajuste correcto del canvas -->
          <canvas id="chartClientes" width="700" height="400" class="!w-full !h-full"></canvas>

        </div>
      </div>
    </div>
  </div>

</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  /* =========================
     GR√ÅFICO: Productos
  ========================== */
  new Chart(document.getElementById('chartProductos'), {
    type: 'bar',
    data: {
      labels: {{ productos_vendidos|pluck:"producto__nombre"|safe }},
      datasets: [{
        label: 'Cantidad vendida',
        data: {{ productos_vendidos|pluck:"total_vendido"|safe }},
        backgroundColor: '#6366f1',
        borderColor: '#4f46e5',
        borderWidth: 2,
        borderRadius: 6
      }]
    },
    options: {
      responsive: false,
      animation: false
    }
  });

  /* =========================
     GR√ÅFICO: Clientes
  ========================== */
  new Chart(document.getElementById('chartClientes'), {
    type: 'pie',
    data: {
      labels: {{ clientes_top|pluck:"cliente__nombre"|safe }},
      datasets: [{
        label: 'Ventas',
        data: {{ clientes_top|pluck:"total_compras"|safe }},
        backgroundColor: ['#4f46e5', '#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe'],
        borderWidth: 2
      }]
    },
    options: {
      responsive: false,
      animation: false
    }
  });
</script>
{% endblock %}


